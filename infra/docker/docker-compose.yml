version: '2.1'

volumes:
  repo-data:
  agent-data: # For SQLite DB

services:
  agent:
    build:
      context: ../../
      dockerfile: apps/agent/Dockerfile
    environment:
      - NODE_ENV=production
      - SUPERVISOR_URL=http://supervisor:4000
      - INTERFACES_URL=http://interfaces:5000
    volumes:
      - repo-data:/app/source
      - agent-data:/app/data
    networks:
      - deedee-net
    restart: always

  supervisor:
    build:
      context: ../../
      dockerfile: apps/supervisor/Dockerfile
    environment:
      - GIT_USER_NAME=Deedee Agent
      - GIT_USER_EMAIL=deedee@bot
      - PORT=4000
    volumes:
      - repo-data:/app/source
    networks:
      - deedee-net
    restart: always

  interfaces:
    build:
      context: ../../
      dockerfile: apps/interfaces/Dockerfile
    environment:
      - NODE_ENV=production
      - AGENT_URL=http://agent:3000
      - PORT=5000
      # TELEGRAM_TOKEN, SLACK_TOKEN injected by Balena
    networks:
      - deedee-net
    restart: always

networks:
  deedee-net:
    driver: bridge
