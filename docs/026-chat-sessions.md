# Chat Sessions Architecture

## Overview
Deedee now supports persistent chat sessions, allowing the user to maintain multiple conversation threads, switch between them, and resume them later. This moves away from the previous "single global chat" model.

## Data Model
A new `chat_sessions` table has been added to the SQLite database (`apps/agent/src/db.js`).

```sql
CREATE TABLE IF NOT EXISTS chat_sessions (
  id TEXT PRIMARY KEY,
  title TEXT,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  updated_at TEXT DEFAULT CURRENT_TIMESTAMP,
  is_archived INTEGER DEFAULT 0
);
```

- **ID**: UUID v4 (or legacy identifiers for Telegram/WhatsApp).
- **Title**: Auto-generated by a small LLM (Gemini Flash) after the first user message.
- **Messages**: Linked to sessions via the existing `messages` table (which already had `metadata` with `chatId`).

## Architecture

1.  **Agent Service**:
    - **`ensureSession(chatId)`**: middleware-like logic that creates a session if one doesn't exist for an incoming message.
    - **Auto-Titling**: A background async process (`_autoTitleSession`) that generates titles without blocking the response.
    - **API**: Internal endpoints (`/internal/sessions`) for CRUD operations.

2.  **Interfaces Service**:
    - Proxies requests from the Web UI to the Agent's internal API.
    - Public Endpoints: `GET /sessions`, `POST /sessions`, `GET /sessions/:id`, etc.

3.  **Web UI**:
    - **Sidebar**: Lists recent sessions. Supports "New Chat".
    - **Dynamic Routing**: `/chat/[id]` acts as the main interface.
    - **Socket.IO**: The socket connection now transmits the `chatId` in the handshake query and in every message event to ensure correct routing.

## Migration
A migration script runs on startup (`migrateSessions`) to backfill session entries for any orphaned messages from the legacy system, ensuring no history is lost.
