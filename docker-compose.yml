version: '2.1'

volumes:
  repo-data:
  agent-data: # For SQLite DB

services:
  agent:
    build:
      context: .
      dockerfile: apps/agent/Dockerfile
    environment:
      - NODE_ENV=production
      - SUPERVISOR_URL=http://supervisor:4000
      - INTERFACES_URL=http://interfaces:5000
      - RATE_LIMIT_HOURLY=50
      - RATE_LIMIT_DAILY=500
      - MAX_TOOL_LOOPS=50
      # - ROUTER_MODEL=gemini-3-flash-preview
      - ROUTER_MODEL=gemini-2.5-flash
      - WORKER_FLASH=gemini-3-flash-preview
      # - WORKER_FLASH=gemini-2.5-flash
      - WORKER_PRO=gemini-3-pro-preview
      - GEMINI_TTS_MODEL=gemini-2.5-flash-preview-tts
      - GEMINI_IMAGE_MODEL=gemini-3-pro-image-preview
    volumes:
      - repo-data:/app/source
      - agent-data:/app/data
    networks:
      - deedee-net
    restart: always

  supervisor:
    build:
      context: .
      dockerfile: apps/supervisor/Dockerfile
    environment:
      - GIT_USER_NAME=Deedee Agent
      - GIT_USER_EMAIL=deedee@bot
      - PORT=4000
    volumes:
      - repo-data:/app/source
      - /var/run/docker.sock:/var/run/docker.sock
    labels:
      io.balena.features.balena-socket: '1'
    networks:
      - deedee-net
    restart: always

  interfaces:
    build:
      context: .
      dockerfile: apps/interfaces/Dockerfile
    environment:
      - NODE_ENV=production
      - AGENT_URL=http://agent:3000
      - PORT=5000
      # TELEGRAM_TOKEN, SLACK_TOKEN injected by Balena
    networks:
      - deedee-net
    restart: always

  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    environment:
      - NODE_ENV=production
      - AGENT_URL=http://agent:3000
      - PORT=3001
      # DEEDEE_API_TOKEN injected by Balena
    ports:
      - "3001:3001"
    networks:
      - deedee-net
    restart: always

  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
    environment:
      - NODE_ENV=production
      - PORT=3000
      - API_URL=http://api:3001
    ports:
      - "3002:3000"
    networks:
      - deedee-net
    restart: always

networks:
  deedee-net:
    driver: bridge
