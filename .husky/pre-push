#!/bin/sh

# 1. Always run Unit Tests
echo "ğŸ§ª Running Unit Tests..."
npm test
if [ $? -ne 0 ]; then
  echo "âŒ Unit tests failed. Push aborted."
  exit 1
fi

# 2. Conditional Web Build
# Read the push range from stdin (local_ref local_sha remote_ref remote_sha)
while read local_ref local_sha remote_ref remote_sha
do
  # Determine the range of commits to check
  if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
    # New branch being pushed: compare against origin/master
    range="origin/master...$local_sha"
  else
    # Existing branch: compare against remote state
    range="$remote_sha...$local_sha"
  fi

  # Check for changes in apps/web
  if git diff --name-only "$range" | grep -q "^apps/web/"; then
    echo "ğŸŒ Web changes detected. Verifying build..."
    npm run build --workspace=apps/web
    if [ $? -ne 0 ]; then
      echo "âŒ Web build failed. Push aborted."
      exit 1
    fi
  else
    echo "â© No web changes detected. Skipping build verification."
  fi
done

exit 0
